# P16 Overview

<img width="3011" height="2096" alt="2025-07-27_18 44 18" src="https://github.com/user-attachments/assets/af91c305-50c6-475f-ae44-ff7390219cea" />

# Running a program

Programs can be loaded by manually setting the 32x32 grid of levers on top of the CPU.

The P16 has 16 pages of program ROM, and the levers form page 0. The other 15 pages are comprised of 3 pages of torch ROM located directly below the levers, and 12 pages of barrel ROM located to the side. Schematics for populating these pages can be generated from an assembly file using the tools in this repository.

# Instruction Set and Assembly Language

## Operations

There are 16 general purpose registers and a data stack.

The table below describes the assembly commands and what they do. The first column is the assembly instruction, the second column is a description of the effect of the instruction, the third column indicates whether the instruction updates the ALU flags. The last column describes how the instruction is translated into machine code, represented as a string of hexadecimal digits 0-9|A-F with lower case letters representing a hexadecimal digit with a variable value.

| Assembly                     | Description                                                                                                                                                                                                                                                                                                         |  Sets ALU Flags?   | Nibbles                                                                                                                                                                                                                                                                                        |
| :--------------------------- | :------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------ | :----------------: | :--------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- |
| `..ROM <page>`               | All instructions which follow are placed in ROM page #`page` until told otherwise where `page` is between 0 and 15.                                                                                                                                                                                                 |         -          | -                                                                                                                                                                                                                                                                                              |
| `..RAM`                      | All instructions which follow are placed in RAM until told otherwise.                                                                                                                                                                                                                                               |         -          | -                                                                                                                                                                                                                                                                                              |
| `.LABEL <label>`             | Label a location in the program.                                                                                                                                                                                                                                                                                    |         -          | -                                                                                                                                                                                                                                                                                              |
| `.USEFLAGS`                  | Placed after an instruction which sets ALU flags to ensure that the next `BRANCH` instruction uses those flags. Additional `PASS` instructions will be inserted to uphold this condition if possible. If a later instruction would overwrite the flags used by the `BRANCH` then the assembly will fail to compile. |         -          | -                                                                                                                                                                                                                                                                                              |
| `PASS`                       | Does nothing.                                                                                                                                                                                                                                                                                                       |        :x:         | `0`                                                                                                                                                                                                                                                                                            |
| `VALUE <value>`              | Push `value` onto the stack.                                                                                                                                                                                                                                                                                        |        :x:         | `1vvvv` where `vvvv` is the 16-bit representation of `value`.                                                                                                                                                                                                                                  |
| `JUMP <label>`               | Continue execution from the`.LABEL` called `label`.                                                                                                                                                                                                                                                                 |        :x:         | `2aa` where `aa` is the address of `label` in the current page.                                                                                                                                                                                                                                |
| `BRANCH <condition> <label>` | Conditionally continue execution from the`.LABEL` called `label` if `condition` is met. See the table below for the possible values for `condition`.                                                                                                                                                                |        :x:         | `3caa` where `aa` is the address of `label` in the current page and `c` encodes the condition.                                                                                                                                                                                                 |
| `PUSH <register>`            | Push `register` onto the data stack.                                                                                                                                                                                                                                                                                |        :x:         | `4r` where `r` is the `register`.                                                                                                                                                                                                                                                              |
| `POP <register>`             | Pop the data stack into `register`.                                                                                                                                                                                                                                                                                 |        :x:         | `5r` where `r` is the `register`.                                                                                                                                                                                                                                                              |
| `CALL <label>`               | Push the current location onto the call stack and continue execution from the`.LABEL` called `label`.                                                                                                                                                                                                               |        :x:         | `6aa` where `aa` is the address of `label` in the current page, or `Cpaa` where `p` is a different ROM page and `aa` is the address of `label` within that page, or `1vvvvDaa` where `vvvv` is the address in RAM of the start of the page and `aa` is the address of `label` within the page. |
| `RETURN`                     | Continue execution from the location popped from the call stack. If the call stack is empty, halt execution.                                                                                                                                                                                                        |        :x:         | `7`                                                                                                                                                                                                                                                                                            |
| `ADD <register>`             | Update the top of the data stack by adding `register`.                                                                                                                                                                                                                                                              | :white_check_mark: | `8r` where `r` is the `register`.                                                                                                                                                                                                                                                              |
| `ROTATE <shift> <register>`  | Rotate `register` to the left by `shift` bits between 0 and 15.                                                                                                                                                                                                                                                     |        :x:         | `9sr` where `s` is the `shift` and `r` is the `register`.                                                                                                                                                                                                                                      |
| `DUP`                        | Push the value on the top of the data stack to the data stack, duplicating it.                                                                                                                                                                                                                                      |        :x:         | `A0`                                                                                                                                                                                                                                                                                           |
| `NOT`                        | Apply a bit-wise NOT to the top of the data stack.                                                                                                                                                                                                                                                                  | :white_check_mark: | `A1`                                                                                                                                                                                                                                                                                           |
| `KREAD`                      | Read from RAM using the address at the top of the data stack. The read value will make its way to the input queue and can be obtained using an `INPUT` instruction.                                                                                                                                                 |        :x:         | `A2`                                                                                                                                                                                                                                                                                           |
| `PREAD`                      | Read from RAM popping the address from the top of the data stack. The read value will make its way to the input queue and can be obtained using an `INPUT` instruction.                                                                                                                                             |        :x:         | `A3`                                                                                                                                                                                                                                                                                           |
| `INC`                        | Increment the top of the data stack.                                                                                                                                                                                                                                                                                | :white_check_mark: | `A4`                                                                                                                                                                                                                                                                                           |
| `CINC`                       | Increment the top of the data stack using the carry flag as carry in.                                                                                                                                                                                                                                               | :white_check_mark: | `A5`                                                                                                                                                                                                                                                                                           |
| `DEC`                        | Decrement the top of the data stack.                                                                                                                                                                                                                                                                                | :white_check_mark: | `A6`                                                                                                                                                                                                                                                                                           |
| `CDEC`                       | Decrement the top of the data stack using the carry flag as carry in.                                                                                                                                                                                                                                               | :white_check_mark: | `A7`                                                                                                                                                                                                                                                                                           |
| `NEG`                        | Negate the top of the data stack.                                                                                                                                                                                                                                                                                   | :white_check_mark: | `A8`                                                                                                                                                                                                                                                                                           |
| `CNEG`                       | Negate the top of the data stack using the carry flag as carry in.                                                                                                                                                                                                                                                  | :white_check_mark: | `A9`                                                                                                                                                                                                                                                                                           |
| `KSETF`                      | Set the ALU flags according to a no-op with the top of the data stack.                                                                                                                                                                                                                                              | :white_check_mark: | `AA`                                                                                                                                                                                                                                                                                           |
| `PSETF`                      | Pop from the data stack and set the ALU flags according to a no-op with the value.                                                                                                                                                                                                                                  | :white_check_mark: | `AB`                                                                                                                                                                                                                                                                                           |
| `RSH`                        | Right-shift the top of the data stack without carry in.                                                                                                                                                                                                                                                             | :white_check_mark: | `AC`                                                                                                                                                                                                                                                                                           |
| `CRSH`                       | Right-shift the top of the data stack using the carry flag as carry in.                                                                                                                                                                                                                                             | :white_check_mark: | `AD`                                                                                                                                                                                                                                                                                           |
| `IRSH`                       | Right-shift the top of the data stack and carry in.                                                                                                                                                                                                                                                                 | :white_check_mark: | `AE`                                                                                                                                                                                                                                                                                           |
| `ARSH`                       | Arithmetic right-shift the top of the data stack; retain the most significant bit instead of carrying in.                                                                                                                                                                                                           | :white_check_mark: | `AF`                                                                                                                                                                                                                                                                                           |
| `SWAP <register>`            | Swap `register` with the top of the data stack.                                                                                                                                                                                                                                                                     |        :x:         | `B0`                                                                                                                                                                                                                                                                                           |
| `SUB <register>`             | Update the top of the data stack by subtracting `register`.                                                                                                                                                                                                                                                         | :white_check_mark: | `B1`                                                                                                                                                                                                                                                                                           |
| `KWRITE <register>`          | Write `register` to RAM at the address at the top of the data stack.                                                                                                                                                                                                                                                |        :x:         | `B2`                                                                                                                                                                                                                                                                                           |
| `PWRITE <register>`          | Write `register` to RAM at the address popped from the data stack.                                                                                                                                                                                                                                                  |        :x:         | `B3`                                                                                                                                                                                                                                                                                           |
| `AND <register>`             | Update the top of the data stack by performing a bit-wise AND with `register`.                                                                                                                                                                                                                                      | :white_check_mark: | `B4`                                                                                                                                                                                                                                                                                           |
| `NAND <register>`            | Update the top of the data stack by performing a bit-wise NAND with `register`.                                                                                                                                                                                                                                     | :white_check_mark: | `B5`                                                                                                                                                                                                                                                                                           |
| `OR <register>`              | Update the top of the data stack by performing a bit-wise OR with `register`.                                                                                                                                                                                                                                       | :white_check_mark: | `B6`                                                                                                                                                                                                                                                                                           |
| `NOR <register>`             | Update the top of the data stack by performing a bit-wise NOR with `register`.                                                                                                                                                                                                                                      | :white_check_mark: | `B7`                                                                                                                                                                                                                                                                                           |
| `XOR <register>`             | Update the top of the data stack by performing a bit-wise XOR with `register`.                                                                                                                                                                                                                                      | :white_check_mark: | `B8`                                                                                                                                                                                                                                                                                           |
| `NXOR <register>`            | Update the top of the data stack by performing a bit-wise NXOR with `register`.                                                                                                                                                                                                                                     | :white_check_mark: | `B9`                                                                                                                                                                                                                                                                                           |
| `SETF <register>`            | Set the ALU flags according to a no-op with `register`.                                                                                                                                                                                                                                                             | :white_check_mark: | `BA`                                                                                                                                                                                                                                                                                           |
| `CMP <register>`             | Subtract `register` from the top of the data stack but do not modify the data stack or `register`. Only use the result to update the ALU flags.                                                                                                                                                                     | :white_check_mark: | `BB`                                                                                                                                                                                                                                                                                           |
| `SADD <register>`            | Update the top of the data stack by adding `register` and simultaneously replace `register` with the old value at the top of the data stack.                                                                                                                                                                        | :white_check_mark: | `BC`                                                                                                                                                                                                                                                                                           |
| `SSUB <register>`            | Update the top of the data stack by subtracting `register` and simultaneously replace `register` with the old value at the top of the data stack.                                                                                                                                                                   | :white_check_mark: | `BD`                                                                                                                                                                                                                                                                                           |
| `CADD <register>`            | Update the top of the data stack by adding `register` using the carry flag as carry in.                                                                                                                                                                                                                             | :white_check_mark: | `BE`                                                                                                                                                                                                                                                                                           |
| `CSUB <register>`            | Update the top of the data stack by subtracting `register` using the carry flag as carry in.                                                                                                                                                                                                                        | :white_check_mark: | `BF`                                                                                                                                                                                                                                                                                           |
| `INPUT`                      | Pop from the input queue onto the top of the data stack. Wait indefinitely for a value if the queue is empty.                                                                                                                                                                                                       |        :x:         | `E`                                                                                                                                                                                                                                                                                            |
| `OUTPUT <path>`              | Pop from the data stack and output the value prefixed by `path` to route the data to the correct destination. Path is a non-empty arbitrary-length sequence of octal digits 0-7 separated by `.` characters.                                                                                                        |        :x:         | `Fp...p` where the least significant 3 bits of each p correspond to the octal digits in `path` and all but the last `p` has its most significant bit set.                                                                                                                                      |

There are four ALU flags `Z`, `N`, `C`, and `V` and an additional flag `I`. The conditions under which each of these flags are set are:

| Flag | Name          | Description                                                                                                    |
| :--- | :------------ | :------------------------------------------------------------------------------------------------------------- |
| `I`  | Input Flag    | Set when the input queue is non-empty.                                                                         |
| `Z`  | Zero Flag     | Set when the result of an ALU operation has all bits 0.                                                        |
| `N`  | Negative Flat | Set when the result of an ALU operation has the most significant bit set.                                      |
| `C`  | Carry Flag    | Set when an ALU operation (addition, subtraction, or shift) produces a carry out.                              |
| `V`  | Overflow Flag | Set when an ALU operation (addition or subtraction) produces a carry out from the second-most significant bit. |

The possible values for `condition` in the `BRANCH` instruction and their meaning in terms of the 5 CPU flags are:

| Assembly | Name                  | Definition       | Nibbles |
| :------- | :-------------------- | :--------------- | :------ |
| `I`      | Input queue non-empty | `I`              | `0`     |
| `!I`     | Input queue empty     | !`I`             | `1`     |
| `Z`      | Zero flag set         | `Z`              | `2`     |
| `!Z`     | Zero flag clear       | !`Z`             | `3`     |
| `N`      | Negative flag set     | `N`              | `4`     |
| `!N`     | Negative flag clear   | !`N`             | `5`     |
| `C`      | Carry flag set        | `C`              | `8`     |
| `!C`     | Carry flag clear      | !`C`             | `9`     |
| `V`      | Overflow flag set     | `V`              | `6`     |
| `!V`     | Overflow flag clear   | !`V`             | `7`     |
| `EQ`     | Equal                 | `Z`              | `2`     |
| `NE`     | Not Equal             | !`Z`             | `3`     |
| `HS`     | Higher or Same        | `C`              | `8`     |
| `LO`     | Lower                 | !`C`             | `9`     |
| `HI`     | Higher                | `C` and !`Z`     | `A`     |
| `LS`     | Lower or Same         | !`C` or `Z`      | `B`     |
| `GE`     | Greater or Equal      | `N`=`V`          | `C`     |
| `LT`     | Less Than             | `N`≠`V`          | `D`     |
| `GT`     | Greater Than          | `N`=`V` and !`Z` | `E`     |
| `LE`     | Less or Equal         | `N`≠`V` or `Z`   | `F`     |

# Create a Schematic0

`cargo run --manifest-path assembly/Cargo.toml -- -a prog.txt -o prog.json; py schematic/main.py prog.json prog.schem`

# Run a simulation

`cargo run --manifest-path assembly/Cargo.toml -q -- -a prog.txt -s`

