# P16

The P16 is a general purpose 16-bit redstone CPU. It has 
 - 8 kilobytes of RAM
 - An additional 2 kilobytes of program ROM
 - 16 general purpose registers
 - An ALU implementing around 30 operations
 - 16 branch conditions based on 5 boolean flags
 - A data stacc (stack accumulator) architecture
 - Hardware call stack
 - Barrel shifter

There is a work in progress online assembler [here](https://pishleback.github.io/P16-Tools/).

<img width="3011" height="2096" alt="2025-07-27_18 44 18" src="https://github.com/user-attachments/assets/af91c305-50c6-475f-ae44-ff7390219cea" />

# Running a program

Simple programs can be loaded by manually setting the 32x32 grid of levers on top of the CPU.

There are 16 pages of program ROM in all. The levers on top are page 0. The other 15 pages are made up of 3 pages of torch ROM located directly below the levers, and 12 additional pages of barrel ROM located to the side. Schematics for populating these pages can be generated from an assembly file using the tools in this repository. A quick start guide is included in this file.

# Instruction Set and Assembly Language

## Operations

There are 16 general purpose registers and a data stack.

The table below describes the assembly commands and what they do. The last column describes how the instruction is translated into machine code, represented as a string of hexadecimal digits 0-9|A-F with lower case letters representing a hexadecimal digit with a variable value.

Example assembly files can be found in the `examples` folder.

| Assembly                     | Description                                                                                                                                                                                                                                                                                                         |  Sets ALU Flags?   | Machine Code                                                                                                                                                                                                                                                                                   |
| :--------------------------- | :------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------ | :----------------: | :--------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- |
| `..ROM <page>`               | All following instructions are placed in ROM page #`page` until told otherwise where `page` is between 0 and 15.                                                                                                                                                                                                    |         -          | -                                                                                                                                                                                                                                                                                              |
| `..RAM`                      | All following instructions are placed in RAM until told otherwise.                                                                                                                                                                                                                                                  |         -          | -                                                                                                                                                                                                                                                                                              |
| `PASS`                       | Does nothing.                                                                                                                                                                                                                                                                                                       |        :x:         | `0`                                                                                                                                                                                                                                                                                            |
| `VALUE <value>`              | Push `value` onto the stack.                                                                                                                                                                                                                                                                                        |        :x:         | `1vvvv` where `vvvv` is the 16-bit representation of `value`.                                                                                                                                                                                                                                  |
| `.LABEL <label>`             | Label a location in the program.                                                                                                                                                                                                                                                                                    |         -          | -                                                                                                                                                                                                                                                                                              |
| `JUMP <label>`               | Continue execution from the`.LABEL` called `label`.                                                                                                                                                                                                                                                                 |        :x:         | `2aa` where `aa` is the address of `label` in the current page.                                                                                                                                                                                                                                |
| `.USEFLAGS`                  | Placed after an instruction which sets ALU flags to ensure that the next `BRANCH` instruction uses those flags. Additional `PASS` instructions will be inserted to uphold this condition if possible. If a later instruction would overwrite the flags used by the `BRANCH` then the assembly will fail to compile. |         -          | -                                                                                                                                                                                                                                                                                              |
| `BRANCH <condition> <label>` | Conditionally continue execution from the`.LABEL` called `label` if `condition` is met. See the table below for the possible values for `condition`.                                                                                                                                                                |        :x:         | `3caa` where `aa` is the address of `label` in the current page and `c` encodes the condition.                                                                                                                                                                                                 |
| `CALL <label>`               | Push the current location onto the call stack and continue execution from the`.LABEL` called `label`.                                                                                                                                                                                                               |        :x:         | `6aa` where `aa` is the address of `label` in the current page, or `Cpaa` where `p` is a different ROM page and `aa` is the address of `label` within that page, or `1vvvvDaa` where `vvvv` is the address in RAM of the start of the page and `aa` is the address of `label` within the page. |
| `RETURN`                     | Continue execution from the location popped from the call stack. If the call stack is empty, halt execution.                                                                                                                                                                                                        |        :x:         | `7`                                                                                                                                                                                                                                                                                            |
| `PUSH <register>`            | Push `register` onto the data stack.                                                                                                                                                                                                                                                                                |        :x:         | `4r` where `r` is the `register`.                                                                                                                                                                                                                                                              |
| `POP <register>`             | Pop the data stack into `register`.                                                                                                                                                                                                                                                                                 |        :x:         | `5r` where `r` is the `register`.                                                                                                                                                                                                                                                              |
| `SWAP <register>`            | Swap `register` with the top of the data stack.                                                                                                                                                                                                                                                                     |        :x:         | `B0r` where `r` is the `register`.                                                                                                                                                                                                                                                             |
| `DUP`                        | Push the value on the top of the data stack to the data stack, duplicating it.                                                                                                                                                                                                                                      |        :x:         | `A0`                                                                                                                                                                                                                                                                                           |
| `KWRITE <register>`          | Write `register` to RAM at the address at the top of the data stack.                                                                                                                                                                                                                                                |        :x:         | `B2r` where `r` is the `register`.                                                                                                                                                                                                                                                             |
| `PWRITE <register>`          | Write `register` to RAM at the address popped from the data stack.                                                                                                                                                                                                                                                  |        :x:         | `B3r` where `r` is the `register`.                                                                                                                                                                                                                                                             |
| `KREAD`                      | Read from RAM using the address at the top of the data stack. The read value will make its way to the input queue and can be obtained using an `INPUT` instruction.                                                                                                                                                 |        :x:         | `A2`                                                                                                                                                                                                                                                                                           |
| `PREAD`                      | Read from RAM popping the address from the top of the data stack. The read value will make its way to the input queue and can be obtained using an `INPUT` instruction.                                                                                                                                             |        :x:         | `A3`                                                                                                                                                                                                                                                                                           |
| `INPUT`                      | Pop from the input queue onto the top of the data stack. Wait indefinitely for a value if the queue is empty.                                                                                                                                                                                                       |        :x:         | `E`                                                                                                                                                                                                                                                                                            |
| `OUTPUT <path>`              | Pop from the data stack and output the value prefixed by `path` to route the data to the correct destination. Path is a non-empty arbitrary-length sequence of octal digits 0-7 separated by `.` characters.                                                                                                        |        :x:         | `Fp...p` where the least significant 3 bits of each p correspond to the octal digits in `path` and all but the last `p` has its most significant bit set.                                                                                                                                      |
| `ADD <register>`             | Update the top of the data stack by adding `register`.                                                                                                                                                                                                                                                              | :white_check_mark: | `8r` where `r` is the `register`.                                                                                                                                                                                                                                                              |
| `CADD <register>`            | Update the top of the data stack by adding `register` using the carry flag as carry in.                                                                                                                                                                                                                             | :white_check_mark: | `BEr` where `r` is the `register`.                                                                                                                                                                                                                                                             |
| `SADD <register>`            | Update the top of the data stack by adding `register` and simultaneously replace `register` with the old value at the top of the data stack.                                                                                                                                                                        | :white_check_mark: | `BCr` where `r` is the `register`.                                                                                                                                                                                                                                                             |
| `SUB <register>`             | Update the top of the data stack by subtracting `register`.                                                                                                                                                                                                                                                         | :white_check_mark: | `B1r` where `r` is the `register`.                                                                                                                                                                                                                                                             |
| `CSUB <register>`            | Update the top of the data stack by subtracting `register` using the carry flag as carry in.                                                                                                                                                                                                                        | :white_check_mark: | `BFr` where `r` is the `register`.                                                                                                                                                                                                                                                             |
| `SSUB <register>`            | Update the top of the data stack by subtracting `register` and simultaneously replace `register` with the old value at the top of the data stack.                                                                                                                                                                   | :white_check_mark: | `BDr` where `r` is the `register`.                                                                                                                                                                                                                                                             |
| `CMP <register>`             | Subtract `register` from the top of the data stack but do not modify the data stack or `register`. Only use the result to update the ALU flags.                                                                                                                                                                     | :white_check_mark: | `BBr` where `r` is the `register`.                                                                                                                                                                                                                                                             |
| `INC`                        | Increment the top of the data stack.                                                                                                                                                                                                                                                                                | :white_check_mark: | `A4`                                                                                                                                                                                                                                                                                           |
| `CINC`                       | Increment the top of the data stack using the carry flag as carry in.                                                                                                                                                                                                                                               | :white_check_mark: | `A5`                                                                                                                                                                                                                                                                                           |
| `DEC`                        | Decrement the top of the data stack.                                                                                                                                                                                                                                                                                | :white_check_mark: | `A6`                                                                                                                                                                                                                                                                                           |
| `CDEC`                       | Decrement the top of the data stack using the carry flag as carry in.                                                                                                                                                                                                                                               | :white_check_mark: | `A7`                                                                                                                                                                                                                                                                                           |
| `NEG`                        | Negate the top of the data stack.                                                                                                                                                                                                                                                                                   | :white_check_mark: | `A8`                                                                                                                                                                                                                                                                                           |
| `CNEG`                       | Negate the top of the data stack using the carry flag as carry in.                                                                                                                                                                                                                                                  | :white_check_mark: | `A9`                                                                                                                                                                                                                                                                                           |
| `NOT`                        | Apply a bit-wise NOT to the top of the data stack.                                                                                                                                                                                                                                                                  | :white_check_mark: | `A1`                                                                                                                                                                                                                                                                                           |
| `AND <register>`             | Update the top of the data stack by performing a bit-wise AND with `register`.                                                                                                                                                                                                                                      | :white_check_mark: | `B4r` where `r` is the `register`.                                                                                                                                                                                                                                                             |
| `NAND <register>`            | Update the top of the data stack by performing a bit-wise NAND with `register`.                                                                                                                                                                                                                                     | :white_check_mark: | `B5r` where `r` is the `register`.                                                                                                                                                                                                                                                             |
| `OR <register>`              | Update the top of the data stack by performing a bit-wise OR with `register`.                                                                                                                                                                                                                                       | :white_check_mark: | `B6r` where `r` is the `register`.                                                                                                                                                                                                                                                             |
| `NOR <register>`             | Update the top of the data stack by performing a bit-wise NOR with `register`.                                                                                                                                                                                                                                      | :white_check_mark: | `B7r` where `r` is the `register`.                                                                                                                                                                                                                                                             |
| `XOR <register>`             | Update the top of the data stack by performing a bit-wise XOR with `register`.                                                                                                                                                                                                                                      | :white_check_mark: | `B8r` where `r` is the `register`.                                                                                                                                                                                                                                                             |
| `NXOR <register>`            | Update the top of the data stack by performing a bit-wise NXOR with `register`.                                                                                                                                                                                                                                     | :white_check_mark: | `B9r` where `r` is the `register`.                                                                                                                                                                                                                                                             |
| `ROTATE <shift> <register>`  | Rotate `register` to the left by `shift` bits between 0 and 15.                                                                                                                                                                                                                                                     |        :x:         | `9sr` where `s` is the `shift` and `r` is the `register`.                                                                                                                                                                                                                                      |
| `RSH`                        | Right-shift the top of the data stack without carry in.                                                                                                                                                                                                                                                             | :white_check_mark: | `AC`                                                                                                                                                                                                                                                                                           |
| `CRSH`                       | Right-shift the top of the data stack using the carry flag as carry in.                                                                                                                                                                                                                                             | :white_check_mark: | `AD`                                                                                                                                                                                                                                                                                           |
| `IRSH`                       | Right-shift the top of the data stack and carry in.                                                                                                                                                                                                                                                                 | :white_check_mark: | `AE`                                                                                                                                                                                                                                                                                           |
| `ARSH`                       | Arithmetic right-shift the top of the data stack; retain the most significant bit instead of carrying in.                                                                                                                                                                                                           | :white_check_mark: | `AF`                                                                                                                                                                                                                                                                                           |
| `SETF <register>`            | Set the ALU flags according to a no-op with `register`.                                                                                                                                                                                                                                                             | :white_check_mark: | `BAr` where `r` is the `register`.                                                                                                                                                                                                                                                             |
| `KSETF`                      | Set the ALU flags according to a no-op with the top of the data stack.                                                                                                                                                                                                                                              | :white_check_mark: | `AA`                                                                                                                                                                                                                                                                                           |
| `PSETF`                      | Pop from the data stack and set the ALU flags according to a no-op with the value.                                                                                                                                                                                                                                  | :white_check_mark: | `AB`                                                                                                                                                                                                                                                                                           |

There are four ALU flags `Z`, `N`, `C`, and `V` and an additional flag `I`. The conditions under which each of these flags are set are:

| Flag | Name          | Description                                                                                                    |
| :--- | :------------ | :------------------------------------------------------------------------------------------------------------- |
| `I`  | Input Flag    | Set when the input queue is non-empty.                                                                         |
| `Z`  | Zero Flag     | Set when the result of an ALU operation has all bits 0.                                                        |
| `N`  | Negative Flat | Set when the result of an ALU operation has the most significant bit set.                                      |
| `C`  | Carry Flag    | Set when an ALU operation (addition, subtraction, or shift) produces a carry out.                              |
| `V`  | Overflow Flag | Set when an ALU operation (addition or subtraction) produces a carry out from the second-most significant bit. |

The possible values for `condition` in the `BRANCH` instruction and their meaning in terms of the 5 flags are:

| Assembly | Name                  | Branches When    | Machine Code |
| :------- | :-------------------- | :--------------- | :----------- |
| `I`      | Input queue non-empty | `I`              | `0`          |
| `!I`     | Input queue empty     | !`I`             | `1`          |
| `Z`      | Zero flag set         | `Z`              | `2`          |
| `!Z`     | Zero flag clear       | !`Z`             | `3`          |
| `N`      | Negative flag set     | `N`              | `4`          |
| `!N`     | Negative flag clear   | !`N`             | `5`          |
| `C`      | Carry flag set        | `C`              | `8`          |
| `!C`     | Carry flag clear      | !`C`             | `9`          |
| `V`      | Overflow flag set     | `V`              | `6`          |
| `!V`     | Overflow flag clear   | !`V`             | `7`          |
| `EQ`     | Equal                 | `Z`              | `2`          |
| `NE`     | Not Equal             | !`Z`             | `3`          |
| `HS`     | Higher or Same        | `C`              | `8`          |
| `LO`     | Lower                 | !`C`             | `9`          |
| `HI`     | Higher                | `C` and !`Z`     | `A`          |
| `LS`     | Lower or Same         | !`C` or `Z`      | `B`          |
| `GE`     | Greater or Equal      | `N`=`V`          | `C`          |
| `LT`     | Less Than             | `N`≠`V`          | `D`          |
| `GT`     | Greater Than          | `N`=`V` and !`Z` | `E`          |
| `LE`     | Less or Equal         | `N`≠`V` or `Z`   | `F`          |

# Getting started

## Prerequisites

 - Install Python 3
 - Install Rust
 - Clone this repository

## Create an assembly file

Create a file `prog.txt` in the root directory and populate it with an assembly program. To get started, copy the following program which takes two values as input, adds them, and outputs the result.

```
..ROM 0
CALL start
RETURN

..ROM 1
.LABEL start
INPUT
INPUT
POP %0
ADD %0
OUTPUT 0.0
RETURN
```

## Compile to machine code

To compile the assembly to machine code, run `cargo run --manifest-path assembly/Cargo.toml --release -- -a prog.txt` in the root directory. The output should look like

```
ROM 0: C1007
ROM 1: EE5080F087
```

It says that ROM page 0 should contain `C1007` and ROM page 1 should contain `EE5080F087`.

## Run a simulation

To simulate this program running on the P16 with inputs `3` and `5`, run `cargo run --manifest-path assembly/Cargo.toml --release -- -a prog.txt -s -i 3,5` in the root directory. The output contains information on the state of the CPU after each instruction and contains the result of 8
```
...
Output
[O0, O0] 8
...
```

## Loading the program using a Schematic file

To run the program on the actual P16 we need to create a worldedit schematic containing the program and paste it into the P16.

1. Run `cargo run --manifest-path assembly/Cargo.toml --release -- -a prog.txt -o prog.json; py schematic/main.py prog.json prog.schem` to generate the schematic. 
2. There is a warning it cannot generate schematics for populating ROM page 0. Rom page 0 is the lever ROM on top of the P16, and this has to be set manually, as shown. <img width="1639" height="1894" alt="2025-07-27_22 13 31" src="https://github.com/user-attachments/assets/56482ae7-c0c9-4314-b940-090c34fb58f1" />
3. Load `prog.schem` into the minecraft world and do `//paste -a` while standing on the start lever to load ROM page 1 onto the P16. <img width="2171" height="1683" alt="2025-07-27_22 13 16" src="https://github.com/user-attachments/assets/510421d2-80b2-4fd2-8dc0-30a455642160" />

## Running on the P16

1. Turn on the start lever. <img width="3840" height="2097" alt="2025-07-27_22 25 21" src="https://github.com/user-attachments/assets/58038a79-5a8b-4717-91a5-235915e25560" />

2. Enter two values on the input panel. <img width="3840" height="2097" alt="2025-07-27_22 13 56" src="https://github.com/user-attachments/assets/89e25405-9af6-4c52-a6f9-3b826e7c4d06" />

3. Wait for the result to appear on the output device. Output path `0.0` is the first column of the binary output. <img width="3840" height="2097" alt="2025-07-27_22 18 26" src="https://github.com/user-attachments/assets/509dd6b3-883c-4eff-8aa0-2acf19bc83a5" />
