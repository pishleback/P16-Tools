# P16 Overview

<img width="3011" height="2096" alt="2025-07-27_18 44 18" src="https://github.com/user-attachments/assets/af91c305-50c6-475f-ae44-ff7390219cea" />

# Running a program

Programs can be loaded by manually setting the 32x32 grid of levers on top of the CPU.

The P16 has 16 pages of program ROM, and the levers form page 0. The other 15 pages are comprised of 3 pages of torch ROM located directly below the levers, and 12 pages of barrel ROM located to the side. Schematics for populating these pages can be generated from an assembly file using the tools in this repository.

# Instruction Set and Assembly Language

## Operations

There are 16 general purpose registers and a data stack.

The table below describes the assembly commands and what they do.

| Assembly                     | Description                                                                                                                                                                                                                                                                                               | Sets ALU Flags?    | Nibbles                                                                                       |
| :--------------------------- | :-------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- | :----------------: | :-------------------------------------------------------------------------------------------- |
| `..ROM <page>`               | All instructions which follow are placed in ROM page #`page` until told otherwise where `page` is between 0 and 15.                                                                                                                                                                                       |                    |                                                                                               |
| `..RAM`                      | All instructions which follow are placed in RAM until told otherwise.                                                                                                                                                                                                                                     |                    |                                                                                               |
| `.LABEL <label>`             | Label a location in the program.                                                                                                                                                                                                                                                                          |                    |                                                                                               |
| `.USEFLAGS`                  | Placed after an instruction which sets ALU flags to ensure that the next `BRANCH` instruction uses those flags. Additional `PASS` instructions will be inserted to ensure this if possible. If a later instruction would overwrite the flags used by the `BRANCH` then the assembly will fail to compile. |                    |                                                                                               |
| `PASS`                       | Does nothing.                                                                                                                                                                                                                                                                                             |                    | `0`                                                                                           |
| `VALUE <value>`              | Push `value` onto the stack.                                                                                                                                                                                                                                                                              |                    | `1VVVV` where `VVVV` is the 16-bit representation of `value`                                  |
| `JUMP <label>`               | Continue execution from the`.LABEL` called `label`.                                                                                                                                                                                                                                                       |                    | `2AA` where `AA` is the address of `label` in the current page                                |
| `BRANCH <condition> <label>` | Conditionally continue execution from the`.LABEL` called `label` if `condition` is met. See the table below for the possible values for `condition`.                                                                                                                                                      |                    | `3CAA` where `AA` is the address of `label` in the current page and `C` encodes the condition |
| `PUSH <register>`            | Push `register` onto the data stack.                                                                                                                                                                                                                                                                      |                    |                                                                                               |
| `POP <register>`             | Pop the data stack into `register`.                                                                                                                                                                                                                                                                       |                    |                                                                                               |
| `CALL <label>`               | Push the current location onto the call stack and continue execution from the`.LABEL` called `label`.                                                                                                                                                                                                     |                    |                                                                                               |
| `RETURN`                     | Continue execution from the location popped from the call stack. If the call stack is empty, halt execution.                                                                                                                                                                                              |                    |                                                                                               |
| `ADD <register>`             | Update the top of the data stack by adding `register`.                                                                                                                                                                                                                                                    |                    |                                                                                               |
| `ROTATE <num> <register>`    |                                                                                                                                                                                                                                                                                                           |                    |                                                                                               |
| `DUP`                        |                                                                                                                                                                                                                                                                                                           |                    |                                                                                               |
| `NOT`                        |                                                                                                                                                                                                                                                                                                           |                    |                                                                                               |
| `KREAD`                      |                                                                                                                                                                                                                                                                                                           |                    |                                                                                               |
| `PREAD`                      |                                                                                                                                                                                                                                                                                                           | :x:                |                                                                                               |
| `INC`                        |                                                                                                                                                                                                                                                                                                           | :white_check_mark: |                                                                                               |
| `CINC`                       |                                                                                                                                                                                                                                                                                                           |                    |                                                                                               |
| `DEC`                        |                                                                                                                                                                                                                                                                                                           |                    |                                                                                               |
| `CDEC`                       |                                                                                                                                                                                                                                                                                                           |                    |                                                                                               |
| `NEG`                        |                                                                                                                                                                                                                                                                                                           |                    |                                                                                               |
| `CNEG`                       |                                                                                                                                                                                                                                                                                                           |                    |                                                                                               |
| `KSETF`                      |                                                                                                                                                                                                                                                                                                           |                    |                                                                                               |
| `PSETF`                      |                                                                                                                                                                                                                                                                                                           |                    |                                                                                               |
| `RSH`                        |                                                                                                                                                                                                                                                                                                           |                    |                                                                                               |
| `CRSH`                       |                                                                                                                                                                                                                                                                                                           |                    |                                                                                               |
| `IRSH`                       |                                                                                                                                                                                                                                                                                                           |                    |                                                                                               |
| `ARSH`                       |                                                                                                                                                                                                                                                                                                           |                    |                                                                                               |
| `SWAP <register>`            |                                                                                                                                                                                                                                                                                                           |                    |                                                                                               |
| `SUB <register>`             |                                                                                                                                                                                                                                                                                                           |                    |                                                                                               |
| `KWRITE <register>`          |                                                                                                                                                                                                                                                                                                           |                    |                                                                                               |
| `PWRITE <register>`          |                                                                                                                                                                                                                                                                                                           |                    |                                                                                               |
| `AND <register>`             |                                                                                                                                                                                                                                                                                                           |                    |                                                                                               |
| `NAND <register>`            |                                                                                                                                                                                                                                                                                                           |                    |                                                                                               |
| `OR <register>`              |                                                                                                                                                                                                                                                                                                           |                    |                                                                                               |
| `NOR <register>`             |                                                                                                                                                                                                                                                                                                           |                    |                                                                                               |
| `XOR <register>`             |                                                                                                                                                                                                                                                                                                           |                    |                                                                                               |
| `NXOR <register>`            |                                                                                                                                                                                                                                                                                                           |                    |                                                                                               |
| `SETF <register>`            |                                                                                                                                                                                                                                                                                                           |                    |                                                                                               |
| `CMP <register>`             |                                                                                                                                                                                                                                                                                                           |                    |                                                                                               |
| `SADD <register>`            |                                                                                                                                                                                                                                                                                                           |                    |                                                                                               |
| `SSUB <register>`            |                                                                                                                                                                                                                                                                                                           |                    |                                                                                               |
| `CADD <register>`            |                                                                                                                                                                                                                                                                                                           |                    |                                                                                               |
| `CSUB <register>`            |                                                                                                                                                                                                                                                                                                           |                    |                                                                                               |
| `RAWRAMCALL`                 |                                                                                                                                                                                                                                                                                                           |                    |                                                                                               |
| `INPUT`                      |                                                                                                                                                                                                                                                                                                           |                    |                                                                                               |
| `OUTPUT <path>`              |                                                                                                                                                                                                                                                                                                           |                    |                                                                                               |

The table below describes the possible values for `condition` in the branch instruction.

| Assembly | Description   | Nibbles |
| :------- | :------------ | :------ |
| `I`      | Input waiting | `0`     |

# Create a Schematic0

`cargo run --manifest-path assembly/Cargo.toml -- -a prog.txt -o prog.json; py schematic/main.py prog.json prog.schem`

# Run a simulation

`cargo run --manifest-path assembly/Cargo.toml -q -- -a prog.txt -s`

